#!/bin/bash
# Démarre/Arrête une connection au VPN de Lille 1

vpnconf=`mktemp /tmp/lille1-XXXX.conf`
ustlcert=`mktemp /tmp/ac-ustl-auth-1x-XXXX.crt`
ustlca=`mktemp /tmp/terena-XXXX.pem`

trap "rm $vpnconf $ustlcert $ustlca" exit

cat <<EOF >$vpnconf
dev tap

## IP DU SERVEUR
<connection>
remote 194.57.139.251 1194 tcp
</connection>

## TYPE DE CONFIG
client

## AUTHENTIFICATION PAR LOGIN/MDP
auth-user-pass

## NOM DU SERVEUR VPN A VERIFIER AU DEMARRAGE
tls-remote vpn

## CERTIFICAT DE L'AUTORITE DE CONFIANCE
# Donné en ligne de commande
#ca Terena-chaine_autorites.pem

## ALGO DE CRYPTAGES
cipher AES-256-CBC

## RELATIF AUX TESTS DE CONNEXION AU SERVEUR VPN
tun-mtu-extra 32
mssfix 1450
pull

##Pour Vista
route-method exe
route-delay 2

## VERIFICATION DU LIEN VPN
ping 10

## COMPRESSION DES DONNEES
comp-lzo

## NIVEAU DE DEBUG
verb 2

#pour les PC windows 2000
#ip-win32 ipapi
EOF

cat <<EOF >$ustlcert
-----BEGIN CERTIFICATE-----
MIIE2zCCA8OgAwIBAgIQUeXxpaK6O6BMU4zS8MtYXTANBgkqhkiG9w0BAQUFADBk
MRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGzAZBgoJkiaJk/IsZAEZFgt1bml2LWxp
bGxlMTEUMBIGCgmSJomT8ixkARkWBHdpZmkxGDAWBgNVBAMTD0FDIFVTVEwgQXV0
aC0xeDAeFw0wNDA5MjkwODM5NTNaFw0xNDA5MjkwODM5NTNaMGQxFTATBgoJkiaJ
k/IsZAEZFgVsb2NhbDEbMBkGCgmSJomT8ixkARkWC3VuaXYtbGlsbGUxMRQwEgYK
CZImiZPyLGQBGRYEd2lmaTEYMBYGA1UEAxMPQUMgVVNUTCBBdXRoLTF4MIIBIjAN
BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0Z9vYjcHY3lXrucBGWSv5NWkq4+L
cMKd7mXbH02oNjjNNwNoqTyQCtViAbUsKcemQbpx4IRJL28okTUp7ZeU/MHKpx99
uWXxXufytPcfG7kXnFbrvNTfrJ7sgjXSg0FQRiqaLTDw3ug555FgyNa+cGIzOqp9
+IyPzw5rI0m9XbpDCsg1qwj+AvfrKdKPcRcSsG24RzxJY5CbBY0vhMCb3iDsDX/0
qssD7MiZeUzhgmYqF6mjBHdOKVX/YSBzS9oshdvrmXKA3nzAQJORlmxeTnr6Nw7Y
s4SWzkzPygH/qIbu4VvcktyPGl9eeSmNRXOB9m5gZSKuJ+Yi7ZuynhYYhwIDAQAB
o4IBhzCCAYMwCwYDVR0PBAQDAgGGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYE
FDRr+k4VqJD81lhzm/Suyr9NIR1zMIIBMAYDVR0fBIIBJzCCASMwggEfoIIBG6CC
AReGgclsZGFwOi8vL0NOPUFDJTIwVVNUTCUyMEF1dGgtMXgsQ049Y3JpMnczZW4s
Q049Q0RQLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENO
PUNvbmZpZ3VyYXRpb24sREM9d2lmaSxEQz11bml2LWxpbGxlMSxEQz1sb2NhbD9j
ZXJ0aWZpY2F0ZVJldm9jYXRpb25MaXN0P2Jhc2U/b2JqZWN0Q2xhc3M9Y1JMRGlz
dHJpYnV0aW9uUG9pbnSGSWh0dHA6Ly9jcmkydzNlbi53aWZpLnVuaXYtbGlsbGUx
LmxvY2FsL0NlcnRFbnJvbGwvQUMlMjBVU1RMJTIwQXV0aC0xeC5jcmwwEAYJKwYB
BAGCNxUBBAMCAQAwDQYJKoZIhvcNAQEFBQADggEBAH6FJPhTZMO8a5xtS+KV9UEK
3Y9IyW1q6Jp+NsRkqT/nBRNkiZQRijSnAuQsR1x5u/9zGjOWrOhaugPFFtNn+G8J
QxsQIfUG2LzEybn3eFrXhIKTmbe36LK53fe9wygIKWPbRBXQ9XhCW7tKqJ+e1Vic
KDZL191JOIamQl9kYpeOYEENQFPNjMLpApJA4THR4ycNzo8oVpAq4Ns5ew2XfxXr
dZ68VMM/LKEZH2bVfjSQ0ipYSjjS5oQI+0G4lWRRvkogYTi9YgFEFmGtxj+LbFxh
D8v7MXvI300HNjsHstMPl9/DZmBC7HWje8ywU3OvJBkcBgoqA3iVc/ThC7JtUs0=
-----END CERTIFICATE-----
EOF

cat <<EOF >$ustlca
-----BEGIN CERTIFICATE-----
MIIEmDCCA4CgAwIBAgIQS8gUAy8H+mqk8Nop32F5ujANBgkqhkiG9w0BAQUFADCB
lzELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAlVUMRcwFQYDVQQHEw5TYWx0IExha2Ug
Q2l0eTEeMBwGA1UEChMVVGhlIFVTRVJUUlVTVCBOZXR3b3JrMSEwHwYDVQQLExho
dHRwOi8vd3d3LnVzZXJ0cnVzdC5jb20xHzAdBgNVBAMTFlVUTi1VU0VSRmlyc3Qt
SGFyZHdhcmUwHhcNMDkwNTE4MDAwMDAwWhcNMjAwNTMwMTA0ODM4WjA2MQswCQYD
VQQGEwJOTDEPMA0GA1UEChMGVEVSRU5BMRYwFAYDVQQDEw1URVJFTkEgU1NMIENB
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAw+NIxC9cwcupmf0booNd
ij2tOtDipEMfTQ7+NSUwpWkbxOjlwY9UfuFqoppcXN49/ALOlrhfj4NbzGBAkPjk
tjolnF8UUeyx56+eUKExVccCvaxSin81joL6hK0V/qJ/gxA6VVOULAEWdJRUYyij
8lspPZSIgCDiFFkhGbSkmOFg5vLrooCDQ+CtaPN5GYtoQ1E/iptBhQw1jF218bbl
p8ODtWsjb9Sl61DllPFKX+4nSxQSFSRMDc9ijbcAIa06Mg9YC18em9HfnY6pGTVQ
L0GprTvG4EWyUzl/Ib8iGodcNK5Sbwd9ogtOnyt5pn0T3fV/g3wvWl13eHiRoBS/
fQIDAQABo4IBPjCCATowHwYDVR0jBBgwFoAUoXJfJhsomEOVXQc31YWWnUvSw0Uw
HQYDVR0OBBYEFAy9k2gM896ro0lrKzdXR+qQ47ntMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEAMBgGA1UdIAQRMA8wDQYLKwYBBAGyMQECAh0wRAYD
VR0fBD0wOzA5oDegNYYzaHR0cDovL2NybC51c2VydHJ1c3QuY29tL1VUTi1VU0VS
Rmlyc3QtSGFyZHdhcmUuY3JsMHQGCCsGAQUFBwEBBGgwZjA9BggrBgEFBQcwAoYx
aHR0cDovL2NydC51c2VydHJ1c3QuY29tL1VUTkFkZFRydXN0U2VydmVyX0NBLmNy
dDAlBggrBgEFBQcwAYYZaHR0cDovL29jc3AudXNlcnRydXN0LmNvbTANBgkqhkiG
9w0BAQUFAAOCAQEATiPuSJz2hYtxxApuc5NywDqOgIrZs8qy1AGcKM/yXA4hRJML
thoh45gBlA5nSYEevj0NTmDa76AxTpXv8916WoIgQ7ahY0OzUGlDYktWYrA0irkT
Q1mT7BR5iPNIk+idyfqHcgxrVqDDFY1opYcfcS3mWm08aXFABFXcoEOUIEU4eNe9
itg5xt8Jt1qaqQO4KBB4zb8BG1oRPjj02Bs0ec8z0gH9rJjNbUcRkEy7uVvYcOfV
r7bMxIbmdcCeKbYrDyqlaQIN4+mitF3A884saoU4dmHGSYKrUbOCprlBmCiY+2v+
ihb/MX5UR6g83EMmqZsFt57ANEORMNQywxFa4Q==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEPDCCAySgAwIBAgIQSEus8arH1xND0aJ0NUmXJTANBgkqhkiG9w0BAQUFADBv
MQswCQYDVQQGEwJTRTEUMBIGA1UEChMLQWRkVHJ1c3QgQUIxJjAkBgNVBAsTHUFk
ZFRydXN0IEV4dGVybmFsIFRUUCBOZXR3b3JrMSIwIAYDVQQDExlBZGRUcnVzdCBF
eHRlcm5hbCBDQSBSb290MB4XDTA1MDYwNzA4MDkxMFoXDTIwMDUzMDEwNDgzOFow
gZcxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJVVDEXMBUGA1UEBxMOU2FsdCBMYWtl
IENpdHkxHjAcBgNVBAoTFVRoZSBVU0VSVFJVU1QgTmV0d29yazEhMB8GA1UECxMY
aHR0cDovL3d3dy51c2VydHJ1c3QuY29tMR8wHQYDVQQDExZVVE4tVVNFUkZpcnN0
LUhhcmR3YXJlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsffDOD+0
qH/POYJRZ9Btn9L/WPPnnyvsDYlUmbk4mRb34CF5SMK7YXQSlh08anLVPBBnOjnt
KxPNZuuVCTOkbJex6MbswXV5nEZejavQav25KlUXEFSzGfCa9vGxXbanbfvgcRdr
ooj7AN/+GjF3DJoBerEy4ysBBzhuw6VeI7xFm3tQwckwj9vlK3rTW/szQB6g1ZgX
vIuHw4nTXaCOsqqq9o5piAbF+okh8widaS4JM5spDUYPjMxJNLBpUb35Bs1orWZM
vD6sYb0KiA7I3z3ufARMnQpea5HW7sftKI2rTYeJc9BupNAeFosU4XZEA39jrOTN
SZzFkvSrMqFIWwIDAQABo4GqMIGnMB8GA1UdIwQYMBaAFK29mHo0tCb3+sQmVO8D
veAky1QaMB0GA1UdDgQWBBShcl8mGyiYQ5VdBzfVhZadS9LDRTAOBgNVHQ8BAf8E
BAMCAQYwDwYDVR0TAQH/BAUwAwEB/zBEBgNVHR8EPTA7MDmgN6A1hjNodHRwOi8v
Y3JsLnVzZXJ0cnVzdC5jb20vQWRkVHJ1c3RFeHRlcm5hbENBUm9vdC5jcmwwDQYJ
KoZIhvcNAQEFBQADggEBADzse+Cuow6WbTDXhcbSaFtFWoKmNA+wyZIjXhFtCBGy
dAkjOjUlc1heyrl8KPpH7PmgA1hQtlPvjNs55Gfp2MooRtSn4PU4dfjny1y/HRE8
akCbLURW0/f/BSgyDBXIZEWT6CEkjy3aeoR7T8/NsiV8dxDTlNEEkaglHAkiD31E
NREU768A/l7qX46w2ZJZuvwTlqAYAVbO2vYoC7Gv3VxPXLLzj1pxz+0YrWOIHY6V
9+qV5x+tkLiECEeFfyIvGh1IMNZMCNg3GWcyK+tc0LL8blefBDVekAB+EcfeEyrN
pG1FJseIVqDwavfY5/wnfmcI0L36tsNhAgFlubgvz1o=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIENjCCAx6gAwIBAgIBATANBgkqhkiG9w0BAQUFADBvMQswCQYDVQQGEwJTRTEU
MBIGA1UEChMLQWRkVHJ1c3QgQUIxJjAkBgNVBAsTHUFkZFRydXN0IEV4dGVybmFs
IFRUUCBOZXR3b3JrMSIwIAYDVQQDExlBZGRUcnVzdCBFeHRlcm5hbCBDQSBSb290
MB4XDTAwMDUzMDEwNDgzOFoXDTIwMDUzMDEwNDgzOFowbzELMAkGA1UEBhMCU0Ux
FDASBgNVBAoTC0FkZFRydXN0IEFCMSYwJAYDVQQLEx1BZGRUcnVzdCBFeHRlcm5h
bCBUVFAgTmV0d29yazEiMCAGA1UEAxMZQWRkVHJ1c3QgRXh0ZXJuYWwgQ0EgUm9v
dDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALf3GjPm8gAELTngTlvt
H7xsD821+iO2zt6bETOXpClMfZOfvUq8k+0DGuOPz+VtUFrWlymUWoCwSXrbLpX9
uMq/NzgtHj6RQa1wVsfwTz/oMp50ysiQVOnGXw94nZpAPA6sYapeFI+eh6FqUNzX
mk6vBbOmcZSccbNQYArHE504B4YCqOmoaSYYkKtMsE8jqzpPhNjfzp/haW+710LX
a0Tkx63ubUFfclpxCDezeWWkWaCUN/cALw3CknLa0Dhy2xSoRcRdKn23tNbE7qzN
E0S3ySvdQwAl+mG5aWpYIxG3pzOPVnVZ9c0p10a3CitlttNCbxWyuHv77+ldU9U0
WicCAwEAAaOB3DCB2TAdBgNVHQ4EFgQUrb2YejS0Jvf6xCZU7wO94CTLVBowCwYD
VR0PBAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wgZkGA1UdIwSBkTCBjoAUrb2YejS0
Jvf6xCZU7wO94CTLVBqhc6RxMG8xCzAJBgNVBAYTAlNFMRQwEgYDVQQKEwtBZGRU
cnVzdCBBQjEmMCQGA1UECxMdQWRkVHJ1c3QgRXh0ZXJuYWwgVFRQIE5ldHdvcmsx
IjAgBgNVBAMTGUFkZFRydXN0IEV4dGVybmFsIENBIFJvb3SCAQEwDQYJKoZIhvcN
AQEFBQADggEBALCb4IUlwtYj4g+WBpKdQZic2YR5gdkeWxQHIzZlj7DYd7usQWxH
YINRsPkyPef89iYTx4AWpb9a/IfPeHmJIZriTAcKhjW88t5RxNKWt9x+Tu5w/Rw5
6wwCURQtjr0W4MHfRnXnJK3s9EK0hZNwEGe6nQY1ShjTK3rMUUKhemPR5ruhxSvC
Nr4TDea9Y355e6cJDUCrat2PisP29owaQgVR1EX1n6diIWgVIEM8med8vSTYqZEX
c4g/VhsxOBi0cQ+azcgOno4uG+GMmIPLHzHxREzGBHNJdmAPx/i9F4BrLunMTA5a
mnkPIAou1Z5jJh5VkpTYghdae9C8x49OhgQ=
-----END CERTIFICATE-----
EOF

# Vérifie la disponibilité d'une commande
verifie ()
{
    ! which "$1" 1>/dev/null 2>&1 && cat <<EOF 1>&2 && exit 1
$(basename $0): $1 n'est pas disponible
EOF
}

# et hop au boulot
case "$1" in
    "start")
        verifie sudo
        verifie openvpn
        sudo openvpn --daemon \
                     --config ${vpnconf} \
                     --ca ${ustlca}
        ;;
    "stop")
        verifie pgrep
        pid=$(pgrep openvpn)
        test -z "$pid" || sudo kill $pid
        ;;
    *)
        echo "$(basename $0) {start|stop}"
        ;;
esac
